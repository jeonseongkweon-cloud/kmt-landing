<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ìˆ˜ë ¨ìƒ ì¡°íšŒ | ê³„ëª…íƒœê¶Œë„</title>
<meta name="description" content="ê³„ëª…íƒœê¶Œë„ ìˆ˜ë ¨ìƒ ì¡°íšŒ. ì´ë¦„/ì•„ì´ë”” + ìƒë…„ì›”ì¼ë¡œ ì•ˆì „í•˜ê²Œ ì¡°íšŒí•©ë‹ˆë‹¤." />
<meta name="theme-color" content="#0b0f19" />

<!-- OG -->
<meta property="og:type" content="website" />
<meta property="og:site_name" content="ê³„ëª…íƒœê¶Œë„" />
<meta property="og:title" content="ìˆ˜ë ¨ìƒ ì¡°íšŒ | ê³„ëª…íƒœê¶Œë„" />
<meta property="og:description" content="ì´ë¦„/ì•„ì´ë”” + ìƒë…„ì›”ì¼ë¡œ ì•ˆì „í•˜ê²Œ ì¡°íšŒí•©ë‹ˆë‹¤." />
<meta property="og:image" content="" />

<style>
  :root{
    --bg:#0b0f19;
    --card:#111827;
    --line:rgba(255,255,255,.10);
    --text:#ffffff;
    --muted:rgba(255,255,255,.72);
    --gold:#f6c945;
    --blue:#60a5fa;
    --green:#34d399;
    --danger:#ff6363;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:18px 16px 28px;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial, sans-serif;
    background: radial-gradient(900px 600px at 50% 0%, rgba(246,201,69,.12), transparent 55%),
                radial-gradient(900px 600px at 10% 20%, rgba(59,130,246,.10), transparent 55%),
                var(--bg);
    color:var(--text);
  }
  a{color:inherit;text-decoration:none}

  /* âœ… ìƒë‹¨ ë°”(í™ˆ ë°”ë¡œê°€ê¸°) */
  .nav{
    max-width:860px;
    margin:0 auto 10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .nav .left{
    display:flex;align-items:center;gap:10px;min-width:0;
  }
  .brand{
    font-weight:950;
    letter-spacing:-.3px;
    font-size:14px;
    color:rgba(255,255,255,.92);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .homeBtn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-weight:950;
    font-size:13px;
  }
  .homeBtn:active{transform:translateY(1px)}

  h1{
    text-align:center;
    margin:6px 0 12px;
    letter-spacing:-.6px;
    font-size:34px;
    font-weight:950;
  }

  .wrap{
    max-width:860px;
    margin:0 auto;
  }

  /* ìƒíƒœ/ë²„íŠ¼ ë°” */
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .status{
    font-size:12px;
    color:rgba(255,255,255,.80);
    display:flex;
    align-items:center;
    gap:8px;
    min-height:20px;
    flex-wrap:wrap;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.88);
    font-weight:950;
  }
  .pill.good{ border-color: rgba(246,201,69,.35); background: rgba(246,201,69,.10); }
  .pill.bad{ border-color: rgba(255,99,99,.35); background: rgba(255,99,99,.10); }
  .pill.blue{ border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.12); }
  .pill.green{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.12); }

  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .miniBtn{
    padding:9px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.92);
    font-weight:950;
    font-size:12px;
    cursor:pointer;
  }
  .miniBtn:active{transform:translateY(1px)}
  .miniBtn.gold{
    border-color: rgba(246,201,69,.35);
    background: rgba(246,201,69,.14);
  }

  /* âœ… ì…ë ¥ UI */
  .form{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    margin:0 auto 12px;
  }
  @media (min-width:720px){
    .form{
      grid-template-columns: 1.2fr 1fr auto;
      align-items:end;
      gap:10px;
    }
  }
  .field{
    background: rgba(255,255,255,.04);
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
  }
  .label{
    font-size:12px;
    color: rgba(255,255,255,.78);
    font-weight:900;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .req{
    font-size:11px;
    color: rgba(246,201,69,.90);
    border:1px solid rgba(246,201,69,.35);
    background: rgba(246,201,69,.10);
    padding:3px 8px;
    border-radius:999px;
    font-weight:950;
    white-space:nowrap;
  }

  .inputWrap{
    position:relative;
    display:flex;
    align-items:center;
    gap:8px;
  }
  input{
    width:100%;
    padding:12px 40px 12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    color:var(--text);
    font-size:16px;
    outline:none;
  }
  input:focus{
    border-color:rgba(246,201,69,.55);
    box-shadow:0 0 0 3px rgba(246,201,69,.15);
  }
  .clearBtn{
    position:absolute;
    right:10px;
    width:28px;height:28px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    color:rgba(255,255,255,.92);
    font-weight:950;
    cursor:pointer;
    display:none;
    align-items:center;
    justify-content:center;
  }
  .clearBtn:active{transform:translateY(1px)}
  .help{
    margin-top:8px;
    font-size:12px;
    color:rgba(255,255,255,.70);
    line-height:1.45;
  }

  .cta{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:stretch;
  }
  button.big{
    width:100%;
    padding:14px 16px;
    border:0;
    border-radius:14px;
    background:var(--gold);
    color:#111;
    font-weight:950;
    cursor:pointer;
    min-width:120px;
    font-size:15px;
  }
  button.big:active{transform:translateY(1px)}
  .note{
    margin-top:10px;
    font-size:12px;
    color:rgba(255,255,255,.70);
    line-height:1.5;
    text-align:center;
  }

  /* ê²°ê³¼ */
  #result{margin-top:10px}
  .message{
    text-align:center;
    margin-top:14px;
    color:var(--muted);
    line-height:1.5;
  }

  /* âœ… ê³µì‹ ì¹´ë“œ(ì—…ê·¸ë ˆì´ë“œ) */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:20px;
    padding:16px;
    max-width:760px;
    margin:14px auto 0;
    box-shadow: 0 14px 30px rgba(0,0,0,.35);
    overflow:hidden;
    position:relative;
  }
  .card::before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(700px 260px at 20% 0%, rgba(246,201,69,.16), transparent 55%),
                radial-gradient(700px 260px at 80% 0%, rgba(96,165,250,.14), transparent 55%);
    opacity:.9;
    pointer-events:none;
  }
  .card > *{ position:relative; }

  .hero{
    display:flex;
    gap:14px;
    align-items:center;
  }
  .photo{
    width:120px;height:120px;border-radius:18px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    overflow:hidden;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,255,255,.55);
    font-weight:950;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .headline{
    min-width:0;
    flex:1;
  }
  .headline h2{
    margin:0 0 6px;
    font-size:24px;
    font-weight:950;
    letter-spacing:-.3px;
  }
  .sub{
    margin:0;
    color:rgba(255,255,255,.78);
    font-size:13px;
    line-height:1.35;
  }
  .badges{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(246,201,69,.35);
    background: rgba(246,201,69,.10);
    color: rgba(255,255,255,.92);
    font-size:12px;
    font-weight:950;
  }
  .badge.green{
    border-color: rgba(52,211,153,.35);
    background: rgba(52,211,153,.12);
  }
  .badge.blue{
    border-color: rgba(96,165,250,.35);
    background: rgba(96,165,250,.12);
  }
  .hashLine{
    margin-top:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    font-size:12px;
    color: rgba(255,255,255,.82);
    word-break:break-all;
  }
  .hashLine b{ color: rgba(255,255,255,.95); }

  .sectionTitle{
    margin:14px 0 8px;
    font-weight:950;
    letter-spacing:-.2px;
    color: rgba(255,255,255,.92);
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sectionTitle .hint{
    font-size:12px;
    color: rgba(255,255,255,.66);
    font-weight:900;
  }

  .grid2{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  @media (min-width:720px){
    .grid2{ grid-template-columns: 1fr 1fr; }
  }
  .panel{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(17,24,39,.55);
    padding:12px;
  }
  .row{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:10px 10px;
    border-radius:14px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
    font-size:14px;
  }
  .row + .row{ margin-top:8px; }
  .rlabel{color:rgba(255,255,255,.70);font-weight:900}
  .rval{color:#fff;font-weight:950;text-align:right; word-break:break-word;}

  /* âœ… ì‹¬ì‚¬ D-Day */
  .examItem{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:10px 10px;
    border-radius:14px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
    margin-top:8px;
  }
  .examLeft{
    min-width:0;
  }
  .examName{
    font-weight:950;
    font-size:13px;
    letter-spacing:-.2px;
  }
  .examDate{
    margin-top:3px;
    font-size:12px;
    color: rgba(255,255,255,.72);
  }
  .dday{
    flex:0 0 auto;
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(96,165,250,.30);
    background: rgba(96,165,250,.12);
    font-weight:950;
    font-size:12px;
    white-space:nowrap;
  }
  .dday.good{
    border-color: rgba(52,211,153,.35);
    background: rgba(52,211,153,.12);
  }
  .dday.bad{
    border-color: rgba(255,99,99,.35);
    background: rgba(255,99,99,.12);
  }

  /* âœ… í•˜ë‹¨ ë²„íŠ¼ */
  .bottomActions{
    margin-top:14px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:space-between;
  }
  .actionBtn{
    flex:1 1 180px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-weight:950;
    cursor:pointer;
  }
  .actionBtn.gold{
    border-color: rgba(246,201,69,.35);
    background: rgba(246,201,69,.14);
    color: rgba(255,255,255,.95);
  }
  .actionBtn:active{ transform: translateY(1px); }

  /* âœ… ë™ëª…ì´ì¸ ë¦¬ìŠ¤íŠ¸ */
  .list{
    max-width:760px;
    margin:14px auto 0;
    display:grid;
    gap:10px;
  }
  .pick{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    padding:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    cursor:pointer;
    transition: transform .10s ease, border-color .15s ease;
  }
  .pick:hover{ transform: translateY(-1px); border-color: rgba(246,201,69,.35); }
  .pick:active{ transform: translateY(0); }
  .pLeft{
    display:flex; align-items:center; gap:12px; min-width:0;
  }
  .thumb{
    width:54px; height:54px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    overflow:hidden;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,255,255,.55);
    font-weight:950;
    font-size:12px;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pInfo{ min-width:0; }
  .pName{ font-weight:950; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pMeta{ font-size:12px; color: rgba(255,255,255,.72); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pGo{
    font-weight:950;
    font-size:12px;
    color: rgba(255,255,255,.92);
    border:1px solid rgba(246,201,69,.28);
    background: rgba(246,201,69,.10);
    padding:7px 10px;
    border-radius:999px;
    white-space:nowrap;
  }
</style>
</head>

<body>

  <!-- âœ… ìƒë‹¨ í™ˆë°” -->
  <div class="nav">
    <div class="left">
      <a class="homeBtn" id="homeBtn" href="../index.html">ğŸ  í™ˆ ë°”ë¡œê°€ê¸°</a>
      <div class="brand">ê³„ëª…íƒœê¶Œë„ Â· ìˆ˜ë ¨ìƒ ì¡°íšŒ</div>
    </div>
  </div>

  <h1>ìˆ˜ë ¨ìƒ ì¡°íšŒ</h1>

  <div class="wrap">

    <div class="topbar">
      <div class="status">
        <span class="pill" id="dataPill">ë°ì´í„°: ì¤€ë¹„ì¤‘</span>
        <span class="pill blue" id="timePill" style="display:none;"></span>
        <span id="statusText">í˜ì´ì§€ê°€ ì—´ë¦¬ë©´ ìë™ìœ¼ë¡œ 1íšŒ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</span>
      </div>
      <div class="actions">
        <button class="miniBtn gold" id="refreshBtn" type="button">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        <button class="miniBtn" id="clearCacheBtn" type="button">ìºì‹œ ì‚­ì œ</button>
      </div>
    </div>

    <!-- âœ… ì…ë ¥ í¼ -->
    <div class="form">
      <div class="field">
        <div class="label">
          <span>ì´ë¦„ ë˜ëŠ” ì•„ì´ë””</span>
          <span class="req">í•„ìˆ˜</span>
        </div>
        <div class="inputWrap">
          <input id="qNameOrId" type="text" placeholder="ì˜ˆ: ê¹€ì˜ˆë‹´ / KM002 / km002" autocomplete="off" />
          <button class="clearBtn" id="clearName" type="button" aria-label="clear">âœ•</button>
        </div>
        <div class="help">â€» ì•„ì´ë””ëŠ” ëŒ€ì†Œë¬¸ì ìƒê´€ì—†ì´ ê²€ìƒ‰ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="field">
        <div class="label">
          <span>ìƒë…„ì›”ì¼</span>
          <span class="req">í•„ìˆ˜</span>
        </div>
        <div class="inputWrap">
          <input id="qBirth" type="text" placeholder="ì˜ˆ: 11.02.13 ë˜ëŠ” 2011.02.13" autocomplete="off" inputmode="numeric" />
          <button class="clearBtn" id="clearBirth" type="button" aria-label="clear">âœ•</button>
        </div>
        <div class="help">â€» ì (.) ì—†ì´ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤. (ì˜ˆ: 110213)</div>
      </div>

      <div class="cta">
        <button class="big" id="searchBtn" type="button">ì¡°íšŒ</button>
      </div>
    </div>

    <div id="result"></div>

    <div class="note">
      ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ <b>ì´ë¦„(ë˜ëŠ” ì•„ì´ë””) + ìƒë…„ì›”ì¼</b>ì´ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ ì¡°íšŒë©ë‹ˆë‹¤.
    </div>

  </div>

<script>
/* =========================================================
  âœ… CHANGE ZONE
========================================================= */
const RAW_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTndQfKXAUuJaAZTbFYFhWbNhlhFmg2tNyaaRJRRLxYGCgUawZUeytRZ-aH9nusJ1SAUHtYYozgO6a0/pub?gid=0&single=true&output=csv";

const GALLERY_BASE = "../gallery/";
const GALLERY_QUERY_KEY = "id";

/* =========================================================
  âœ… Cache/Retry/Timeout
========================================================= */
const CACHE_KEY = "KMT_STUDENTS_CACHE_V4";
const CACHE_TTL_MS = 10 * 60 * 1000;     // 10ë¶„
const FETCH_TIMEOUT_MS = 8000;           // 8ì´ˆ
const RETRY_COUNT = 2;                   // ì´ 3íšŒ ì‹œë„

const $ = (id)=>document.getElementById(id);
const dataPill = $("dataPill");
const timePill = $("timePill");
const statusText = $("statusText");
const resultEl = $("result");

let DATA_ROWS = null;
let LOADING_PROMISE = null;
let LAST_LOADED_AT = null;
let LAST_SOURCE = null;

/* ---------- utils ---------- */
function clean(v){
  return (v ?? "")
    .toString()
    .replace(/^\uFEFF/, "")
    .replace(/\r/g, "")
    .replace(/^"|"$/g, "")
    .trim();
}
function norm(v){
  return clean(v).replace(/\s+/g,"").toLowerCase();
}
function onlyDigits(v){
  return clean(v).replace(/[^\d]/g,"");
}
function normBirth(v){
  const d = onlyDigits(v);
  if(!d) return "";
  if(d.length === 6) return d;
  if(d.length === 8) return d.slice(2);
  return d;
}
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}
function fmtTime(dt){
  try{
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    const d = String(dt.getDate()).padStart(2,"0");
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${d} ${hh}:${mm}`;
  }catch{
    return "";
  }
}

function parseDateAny(v){
  const s = clean(v);
  if(!s) return null;
  if(/ë¯¸ì •/i.test(s)) return null;
  const digits = s.replace(/[^\d]/g,"");
  if(digits.length === 8){
    const y = Number(digits.slice(0,4));
    const m = Number(digits.slice(4,6));
    const d = Number(digits.slice(6,8));
    if(!y || !m || !d) return null;
    return new Date(y, m-1, d);
  }
  const m = s.match(/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/);
  if(m){
    const y = Number(m[1]);
    const mm = Number(m[2]);
    const dd = Number(m[3]);
    return new Date(y, mm-1, dd);
  }
  return null;
}
function fmtDateShort(dt){
  if(!dt) return "ë¯¸ì •";
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function ddayText(dt){
  if(!dt) return { label:"ë¯¸ì •", cls:"" };
  const today = new Date();
  const a = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const b = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  const diff = Math.round((b - a) / (1000*60*60*24));
  if(diff === 0) return { label:"D-Day", cls:"good" };
  if(diff > 0) return { label:`D-${diff}`, cls:"" };
  return { label:`D+${Math.abs(diff)}`, cls:"bad" };
}

async function sha256Hex(text){
  try{
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  }catch{
    return "";
  }
}

/* ---------- CSV parse ---------- */
function splitCSVLine(line){
  const out = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(ch === "," && !inQuotes){
      out.push(cur); cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  const lines = text
    .split("\n")
    .map(l => l.replace(/\r/g,""))
    .filter(l => l.trim() !== "");

  const rows = lines
    .map(splitCSVLine)
    .map(cols => cols.map(clean));

  return rows;
}

/* ---------- cache ---------- */
function readCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.savedAt || !Array.isArray(obj.rows)) return null;
    if(Date.now() - obj.savedAt > CACHE_TTL_MS) return null;
    return obj;
  }catch{
    return null;
  }
}
function writeCache(rows, savedAt){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      savedAt: savedAt || Date.now(),
      rows
    }));
  }catch{}
}
function clearCache(){
  try{ localStorage.removeItem(CACHE_KEY); }catch{}
}

/* ---------- fetch with timeout ---------- */
async function fetchWithTimeout(url, ms){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }finally{
    clearTimeout(t);
  }
}
async function fetchCSVText(){
  try{
    return await fetchWithTimeout(RAW_CSV, FETCH_TIMEOUT_MS);
  }catch(e1){
    const proxied = "https://api.allorigins.win/raw?url=" + encodeURIComponent(RAW_CSV);
    return await fetchWithTimeout(proxied, FETCH_TIMEOUT_MS);
  }
}

/* ---------- status UI ---------- */
function setStatus(type, pillText, msg){
  if(type === "good"){
    dataPill.className = "pill good";
  }else if(type === "bad"){
    dataPill.className = "pill bad";
  }else{
    dataPill.className = "pill";
  }
  dataPill.textContent = "ë°ì´í„°: " + pillText;
  statusText.textContent = msg || "";
}
function setTimePill(){
  if(!LAST_LOADED_AT){
    timePill.style.display = "none";
    return;
  }
  timePill.style.display = "inline-flex";
  const src = LAST_SOURCE === "cache" ? "ìºì‹œ" : "ìµœì‹ ";
  timePill.textContent = `ì—…ë°ì´íŠ¸: ${fmtTime(LAST_LOADED_AT)} Â· ${src}`;
}

/* ---------- load once ---------- */
async function loadOnce({force=false}={}){
  if(DATA_ROWS && !force) return DATA_ROWS;

  if(!force){
    const cached = readCache();
    if(cached){
      DATA_ROWS = cached.rows;
      LAST_LOADED_AT = new Date(cached.savedAt);
      LAST_SOURCE = "cache";
      setStatus("good", `ì¤€ë¹„(${DATA_ROWS.length}ëª…)`, `ì¡°íšŒëŠ” ê¸°ê¸° ì•ˆì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ë©ë‹ˆë‹¤`);
      setTimePill();
      return DATA_ROWS;
    }
  }

  if(LOADING_PROMISE) return LOADING_PROMISE;

  setStatus("loading", "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");
  timePill.style.display = "none";

  LOADING_PROMISE = (async ()=>{
    let lastErr = null;

    for(let i=0;i<=RETRY_COUNT;i++){
      try{
        const csvText = await fetchCSVText();
        const rows = parseCSV(csvText);
        const data = rows.slice(1).filter(r => r && r.length && clean(r[0]) !== "");

        DATA_ROWS = data;
        LAST_LOADED_AT = new Date();
        LAST_SOURCE = "network";
        writeCache(data, Date.now());

        setStatus("good", `ì¤€ë¹„(${DATA_ROWS.length}ëª…)`, "ì¡°íšŒëŠ” ê¸°ê¸° ì•ˆì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ë©ë‹ˆë‹¤");
        setTimePill();
        return DATA_ROWS;
      }catch(err){
        lastErr = err;
        setStatus("loading", "ì¬ì‹œë„", `ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨â€¦ ì¬ì‹œë„ ì¤‘ (${i+1}/${RETRY_COUNT+1})`);
        await new Promise(r => setTimeout(r, 500 * (i+1)));
      }
    }

    throw lastErr;
  })();

  try{
    return await LOADING_PROMISE;
  }finally{
    LOADING_PROMISE = null;
  }
}

/* =========================================================
  âœ… Matching logic (ì´ë¦„/ì•„ì´ë””/ìƒë…„ì›”ì¼)
========================================================= */
function matchRows(qNameOrId, qBirth){
  const q1 = norm(qNameOrId);
  const qb = normBirth(qBirth);

  if(!q1 || !qb) return [];

  const out = [];
  for(const r of DATA_ROWS){
    const id = norm(r[0]);
    const name = norm(r[1]);
    const birth = normBirth(r[2]);

    const okNameOrId = (id && id === q1) || (name && name === q1) || (name && name.includes(q1)) || (id && id.includes(q1));
    const okBirth = (birth && birth === qb);

    if(okNameOrId && okBirth) out.push(r);
  }

  out.sort((a,b)=> String(a[1]||"").localeCompare(String(b[1]||"")) || String(a[0]||"").localeCompare(String(b[0]||"")));
  return out;
}

/* ---------- UI render ---------- */
function galleryUrlForStudent(id){
  const base = GALLERY_BASE || "../gallery/";
  const key = encodeURIComponent(GALLERY_QUERY_KEY || "id");
  const val = encodeURIComponent(clean(id));
  const join = base.includes("?") ? "&" : "?";
  return `${base}${join}${key}=${val}`;
}

function renderExam(name, dateStr){
  const dt = parseDateAny(dateStr);
  const d = ddayText(dt);
  const shownDate = dt ? fmtDateShort(dt) : "ë¯¸ì •";
  const cls = d.cls ? `dday ${d.cls}` : "dday";
  const label = dt ? d.label : "ë¯¸ì •";
  return `
    <div class="examItem">
      <div class="examLeft">
        <div class="examName">${escapeHtml(name)}</div>
        <div class="examDate">ë‹¤ìŒ ì‹¬ì‚¬ì¼: <b>${escapeHtml(shownDate)}</b></div>
      </div>
      <div class="${cls}">â³ ${escapeHtml(label)}</div>
    </div>
  `;
}

function renderCard(row){
  const id = clean(row[0]);
  const name = clean(row[1]);
  const birth = clean(row[2]);

  const tkd = clean(row[3]);
  const ipma = clean(row[4]);
  const tkkd = clean(row[5]);
  const photo = clean(row[6]);

  const point = clean(row[7]);
  const awards = clean(row[8]);
  const cert = clean(row[9]);

  const nextTkd = clean(row[10]);
  const nextIpma = clean(row[11]);
  const nextTkkd = clean(row[12]);

  const hashSource = `KMT|${id}|${name}|${normBirth(birth)}|${tkd}|${ipma}|${tkkd}|${point}|${awards}|${cert}|${nextTkd}|${nextIpma}|${nextTkkd}`;

  return `
    <div class="card" data-hash-source="${escapeHtml(hashSource)}">
      <div class="hero">
        <div class="photo">
          ${
            photo
              ? `<img src="${escapeHtml(photo)}"
                      alt="ì‚¬ì§„"
                      loading="lazy"
                      decoding="async"
                      referrerpolicy="no-referrer"
                      onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='NO PHOTO';" />`
              : `NO PHOTO`
          }
        </div>
        <div class="headline">
          <h2>${escapeHtml(name || "-")}</h2>
          <p class="sub">ì•„ì´ë””: <b>${escapeHtml(id || "-")}</b> Â· ìƒë…„ì›”ì¼: <b>${escapeHtml(birth || "-")}</b></p>
          <div class="badges">
            <div class="badge green">âœ… Verified Record</div>
            <div class="badge blue">ğŸ”’ ì¡°íšŒ ì¸ì¦ ì½”ë“œ ìƒì„±</div>
          </div>
          <div class="hashLine">
            Data Integrity Verified Â· SHA-256 :
            <b id="hashOut">ìƒì„±ì¤‘â€¦</b>
          </div>
        </div>
      </div>

      <div class="sectionTitle">
        <span>ê¸°ë³¸ ì •ë³´</span>
        <span class="hint">ìµœì†Œ ì •ë³´ë§Œ í‘œì‹œ</span>
      </div>

      <div class="grid2">
        <div class="panel">
          <div class="row"><span class="rlabel">í˜„ì¬ í¬ì¸íŠ¸</span><span class="rval">${escapeHtml(point || "0")}</span></div>
          <div class="row"><span class="rlabel">ë³´ìœ  ì¸ì¦ì„œ</span><span class="rval">${escapeHtml(cert || "-")}</span></div>
        </div>
        <div class="panel">
          <div class="row"><span class="rlabel">ìˆ˜ìƒ ê¸°ë¡</span><span class="rval">${escapeHtml(awards || "-")}</span></div>
          <div class="row"><span class="rlabel">ìƒíƒœ</span><span class="rval">ì¡°íšŒ ì™„ë£Œ</span></div>
        </div>
      </div>

      <div class="sectionTitle">
        <span>ë‹¨ì¦ / ì‹¬ì‚¬</span>
        <span class="hint">íƒœê¶Œë„ Â· ê²½í˜¸ë¬´ìˆ  Â· íƒœê¶Œê²€ë„</span>
      </div>

      <div class="panel">
        <div class="row"><span class="rlabel">íƒœê¶Œë„ ë‹¨ì¦</span><span class="rval">${escapeHtml(tkd || "-")}</span></div>
        ${renderExam("íƒœê¶Œë„", nextTkd)}

        <div class="row" style="margin-top:10px;"><span class="rlabel">ê²½í˜¸ë¬´ìˆ  ë‹¨ì¦</span><span class="rval">${escapeHtml(ipma || "-")}</span></div>
        ${renderExam("ê²½í˜¸ë¬´ìˆ ", nextIpma)}

        <div class="row" style="margin-top:10px;"><span class="rlabel">íƒœê¶Œê²€ë„ ë‹¨ì¦</span><span class="rval">${escapeHtml(tkkd || "-")}</span></div>
        ${renderExam("íƒœê¶Œê²€ë„", nextTkkd)}
      </div>

      <div class="bottomActions">
        <a class="actionBtn gold" href="${escapeHtml(galleryUrlForStudent(id))}">ğŸ–¼ï¸ ì‚¬ì§„ ë°”ë¡œë³´ê¸°(ì¡°íšŒ)</a>
        <button class="actionBtn" type="button" id="reSearchBtn">ğŸ” ë‹¤ë¥¸ ìˆ˜ë ¨ìƒ ì¡°íšŒ</button>
      </div>
    </div>
  `;
}

function renderPickList(rows){
  const list = rows.map((r, idx)=>{
    const id = clean(r[0]);
    const name = clean(r[1]);
    const birth = clean(r[2]);
    const photo = clean(r[6]);

    return `
      <div class="pick" data-idx="${idx}">
        <div class="pLeft">
          <div class="thumb">
            ${
              photo
                ? `<img src="${escapeHtml(photo)}" alt="ì‚¬ì§„" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                        onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='NO';" />`
                : `NO`
            }
          </div>
          <div class="pInfo">
            <div class="pName">${escapeHtml(name || "-")}</div>
            <div class="pMeta">ì•„ì´ë””: ${escapeHtml(id || "-")} Â· ìƒë…„ì›”ì¼: ${escapeHtml(birth || "-")}</div>
          </div>
        </div>
        <div class="pGo">ì„ íƒ</div>
      </div>
    `;
  }).join("");

  return `<div class="message">ë™ì¼ ì¡°ê±´ìœ¼ë¡œ <b>${rows.length}ëª…</b>ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
          <div class="list" id="pickList">${list}</div>`;
}

async function applyHashToCurrentCard(){
  const card = resultEl.querySelector(".card");
  if(!card) return;
  const out = card.querySelector("#hashOut");
  if(!out) return;
  const src = card.getAttribute("data-hash-source") || "";
  out.textContent = "ìƒì„±ì¤‘â€¦";
  const hex = await sha256Hex(src);
  if(hex){
    const pretty = `${hex.slice(0,8)}-${hex.slice(8,16)}-${hex.slice(16,24)}-${hex.slice(24,32)}â€¦`;
    out.textContent = pretty;
  }else{
    out.textContent = "ì§€ì›ë˜ì§€ ì•ŠìŒ";
  }
}

/* ---------- search ---------- */
async function runSearch(){
  const q1 = $("qNameOrId").value;
  const qb = $("qBirth").value;

  resultEl.innerHTML = "";

  if(!clean(q1) || !clean(qb)){
    resultEl.innerHTML = `<div class="message">ì´ë¦„(ë˜ëŠ” ì•„ì´ë””)ê³¼ ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
    return;
  }

  try{
    await loadOnce({force:false});
  }catch(e){
    console.error(e);
    setStatus("bad", "ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    resultEl.innerHTML = `<div class="message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br/>ìƒë‹¨ì˜ <b>ë°ì´í„° ìƒˆë¡œê³ ì¹¨</b>ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
    return;
  }

  const rows = matchRows(q1, qb);

  if(rows.length === 0){
    resultEl.innerHTML = `<div class="message">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  if(rows.length === 1){
    resultEl.innerHTML = renderCard(rows[0]);
    await applyHashToCurrentCard();
    bindReSearchButton();
    return;
  }

  resultEl.innerHTML = renderPickList(rows);

  const pickList = $("pickList");
  if(pickList){
    pickList.addEventListener("click", async (e)=>{
      const el = e.target.closest(".pick");
      if(!el) return;
      const idx = Number(el.getAttribute("data-idx"));
      const chosen = rows[idx];
      if(chosen){
        resultEl.innerHTML = renderCard(chosen);
        await applyHashToCurrentCard();
        bindReSearchButton();
      }
    });
  }
}

function bindReSearchButton(){
  const btn = $("reSearchBtn");
  if(!btn) return;
  btn.addEventListener("click", ()=>{
    resultEl.innerHTML = "";
    $("qNameOrId").focus();
    window.scrollTo({top:0, behavior:"smooth"});
  }, { once:true });
}

/* ---------- clear buttons ---------- */
function bindClear(inputId, btnId){
  const input = $(inputId);
  const btn = $(btnId);

  function sync(){
    btn.style.display = input.value ? "inline-flex" : "none";
  }
  input.addEventListener("input", sync);
  btn.addEventListener("click", ()=>{
    input.value = "";
    input.focus();
    sync();
  });
  sync();
}

/* ---------- events ---------- */
$("searchBtn").addEventListener("click", runSearch);
document.addEventListener("keydown",(e)=>{ if(e.key === "Enter") runSearch(); });

$("refreshBtn").addEventListener("click", async ()=>{
  resultEl.innerHTML = "";
  try{
    clearCache();
    DATA_ROWS = null;
    LAST_LOADED_AT = null;
    LAST_SOURCE = null;
    await loadOnce({force:true});
  }catch(e){
    console.error(e);
    setStatus("bad", "ì˜¤ë¥˜", "ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨â€¦ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
});

$("clearCacheBtn").addEventListener("click", ()=>{
  clearCache();
  DATA_ROWS = null;
  LAST_LOADED_AT = null;
  LAST_SOURCE = null;
  timePill.style.display = "none";
  setStatus("loading", "ìºì‹œ ì‚­ì œë¨", "ë‹¤ìŒ ì¡°íšŒ ì‹œ ìƒˆë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
});

bindClear("qNameOrId", "clearName");
bindClear("qBirth", "clearBirth");

window.addEventListener("DOMContentLoaded", ()=>{
  loadOnce({force:false}).catch(e=>{
    console.error(e);
    setStatus("bad", "ëŒ€ê¸°", "ìë™ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒë‹¨ â€˜ë°ì´í„° ìƒˆë¡œê³ ì¹¨â€™ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
  });
});
</script>
</body>
</html>
