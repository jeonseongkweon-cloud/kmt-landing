<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ìˆ˜ë ¨ìƒ ì¡°íšŒ</title>

<style>
  :root{
    --bg:#0b0f19;
    --card:#111827;
    --line:rgba(255,255,255,.10);
    --text:#ffffff;
    --muted:rgba(255,255,255,.72);
    --gold:#f6c945;
    --blue:#60a5fa;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:18px 16px 28px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(900px 600px at 50% 0%, rgba(246,201,69,.12), transparent 55%),
                radial-gradient(900px 600px at 10% 20%, rgba(59,130,246,.10), transparent 55%),
                var(--bg);
    color:var(--text);
  }
  a{color:inherit;text-decoration:none}

  /* âœ… ìƒë‹¨ ë°”(í™ˆ ë°”ë¡œê°€ê¸°) */
  .nav{
    max-width:860px;
    margin:0 auto 10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .nav .left{
    display:flex;align-items:center;gap:10px;min-width:0;
  }
  .brand{
    font-weight:950;
    letter-spacing:-.3px;
    font-size:14px;
    color:rgba(255,255,255,.92);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .homeBtn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-weight:950;
    font-size:13px;
  }
  .homeBtn:active{transform:translateY(1px)}

  h1{
    text-align:center;
    margin:6px 0 12px;
    letter-spacing:-.6px;
    font-size:34px;
    font-weight:950;
  }

  .wrap{
    max-width:860px;
    margin:0 auto;
  }

  /* ìƒíƒœ/ë²„íŠ¼ ë°” */
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .status{
    font-size:12px;
    color:rgba(255,255,255,.80);
    display:flex;
    align-items:center;
    gap:8px;
    min-height:20px;
    flex-wrap:wrap;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.88);
    font-weight:950;
  }
  .pill.good{ border-color: rgba(246,201,69,.35); background: rgba(246,201,69,.10); }
  .pill.bad{ border-color: rgba(255,99,99,.35); background: rgba(255,99,99,.10); }
  .pill.blue{ border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.12); }

  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .miniBtn{
    padding:9px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.92);
    font-weight:950;
    font-size:12px;
    cursor:pointer;
  }
  .miniBtn:active{transform:translateY(1px)}
  .miniBtn.gold{
    border-color: rgba(246,201,69,.35);
    background: rgba(246,201,69,.14);
  }

  /* âœ… ì…ë ¥ UI */
  .form{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    margin:0 auto 12px;
  }
  @media (min-width:720px){
    .form{
      grid-template-columns: 1.2fr 1fr auto;
      align-items:end;
      gap:10px;
    }
  }
  .field{
    background: rgba(255,255,255,.04);
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
  }
  .label{
    font-size:12px;
    color: rgba(255,255,255,.78);
    font-weight:900;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .req{
    font-size:11px;
    color: rgba(246,201,69,.90);
    border:1px solid rgba(246,201,69,.35);
    background: rgba(246,201,69,.10);
    padding:3px 8px;
    border-radius:999px;
    font-weight:950;
    white-space:nowrap;
  }

  .inputWrap{
    position:relative;
    display:flex;
    align-items:center;
    gap:8px;
  }
  input{
    width:100%;
    padding:12px 40px 12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    color:var(--text);
    font-size:16px;
    outline:none;
  }
  input:focus{
    border-color:rgba(246,201,69,.55);
    box-shadow:0 0 0 3px rgba(246,201,69,.15);
  }
  .clearBtn{
    position:absolute;
    right:10px;
    width:28px;height:28px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    color:rgba(255,255,255,.92);
    font-weight:950;
    cursor:pointer;
    display:none;
    align-items:center;
    justify-content:center;
  }
  .clearBtn:active{transform:translateY(1px)}
  .help{
    margin-top:8px;
    font-size:12px;
    color:rgba(255,255,255,.70);
    line-height:1.45;
  }

  .cta{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:stretch;
  }
  button.big{
    width:100%;
    padding:14px 16px;
    border:0;
    border-radius:14px;
    background:var(--gold);
    color:#111;
    font-weight:950;
    cursor:pointer;
    min-width:120px;
    font-size:15px;
  }
  button.big:active{transform:translateY(1px)}
  .note{
    margin-top:10px;
    font-size:12px;
    color:rgba(255,255,255,.70);
    line-height:1.5;
    text-align:center;
  }

  /* ê²°ê³¼ */
  #result{margin-top:10px}
  .message{
    text-align:center;
    margin-top:14px;
    color:var(--muted);
    line-height:1.5;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:18px;
    padding:16px;
    max-width:720px;
    margin:14px auto 0;
    box-shadow: 0 14px 30px rgba(0,0,0,.35);
  }
  .top{
    display:flex;
    gap:14px;
    align-items:center;
  }
  .photo{
    width:110px;height:110px;border-radius:16px;
    background: rgba(255,255,255,.06);
    border:1px solid var(--line);
    overflow:hidden;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,255,255,.55);
    font-weight:900;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .nameblock h2{
    margin:0 0 6px;
    font-size:24px;
    font-weight:950;
    letter-spacing:-.3px;
  }
  .nameblock .sub{
    margin:0;
    color:rgba(255,255,255,.72);
    font-size:13px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    margin-top:10px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(246,201,69,.35);
    background: rgba(246,201,69,.10);
    color: rgba(255,255,255,.90);
    font-size:12px;
    font-weight:900;
  }

  .grid{
    margin-top:14px;
    display:grid;
    grid-template-columns:1fr;
    gap:8px;
  }
  .row{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:11px 12px;
    border-radius:14px;
    background: rgba(17,24,39,.55);
    border:1px solid rgba(255,255,255,.07);
    font-size:14px;
  }
  .rlabel{color:rgba(255,255,255,.70);font-weight:900}
  .rval{color:#fff;font-weight:900;text-align:right; word-break:break-word;}

  /* âœ… ë™ëª…ì´ì¸ ë¦¬ìŠ¤íŠ¸ */
  .list{
    max-width:720px;
    margin:14px auto 0;
    display:grid;
    gap:10px;
  }
  .pick{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    padding:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    cursor:pointer;
    transition: transform .10s ease, border-color .15s ease;
  }
  .pick:hover{ transform: translateY(-1px); border-color: rgba(246,201,69,.35); }
  .pick:active{ transform: translateY(0); }
  .pLeft{
    display:flex; align-items:center; gap:12px; min-width:0;
  }
  .thumb{
    width:54px; height:54px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    overflow:hidden;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,255,255,.55);
    font-weight:950;
    font-size:12px;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .pInfo{ min-width:0; }
  .pName{ font-weight:950; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pMeta{ font-size:12px; color: rgba(255,255,255,.72); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pGo{
    font-weight:950;
    font-size:12px;
    color: rgba(255,255,255,.92);
    border:1px solid rgba(246,201,69,.28);
    background: rgba(246,201,69,.10);
    padding:7px 10px;
    border-radius:999px;
    white-space:nowrap;
  }
</style>
</head>

<body>

  <!-- âœ… ìƒë‹¨ í™ˆë°” -->
  <div class="nav">
    <div class="left">
      <a class="homeBtn" id="homeBtn" href="../">ğŸ  í™ˆ ë°”ë¡œê°€ê¸°</a>
      <div class="brand">ê³„ëª…íƒœê¶Œë„ Â· ìˆ˜ë ¨ìƒ ì¡°íšŒ</div>
    </div>
  </div>

  <h1>ìˆ˜ë ¨ìƒ ì¡°íšŒ</h1>

  <div class="wrap">

    <div class="topbar">
      <div class="status">
        <span class="pill" id="dataPill">ë°ì´í„°: ì¤€ë¹„ì¤‘</span>
        <span class="pill blue" id="timePill" style="display:none;"></span>
        <span id="statusText">í˜ì´ì§€ê°€ ì—´ë¦¬ë©´ ìë™ìœ¼ë¡œ 1íšŒ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</span>
      </div>
      <div class="actions">
        <button class="miniBtn gold" id="refreshBtn" type="button">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        <button class="miniBtn" id="clearCacheBtn" type="button">ìºì‹œ ì‚­ì œ</button>
      </div>
    </div>

    <!-- âœ… ì…ë ¥ í¼ -->
    <div class="form">
      <div class="field">
        <div class="label">
          <span>ì´ë¦„ ë˜ëŠ” ì•„ì´ë””</span>
          <span class="req">í•„ìˆ˜</span>
        </div>
        <div class="inputWrap">
          <input id="qNameOrId" type="text" placeholder="ì˜ˆ: ê¹€ì˜ˆì„± / KM002 / km002" autocomplete="off" />
          <button class="clearBtn" id="clearName" type="button" aria-label="clear">âœ•</button>
        </div>
        <div class="help">â€» ì•„ì´ë””ëŠ” ëŒ€ì†Œë¬¸ì ìƒê´€ì—†ì´ ê²€ìƒ‰ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="field">
        <div class="label">
          <span>ìƒë…„ì›”ì¼</span>
          <span class="req">í•„ìˆ˜</span>
        </div>
        <div class="inputWrap">
          <input id="qBirth" type="text" placeholder="ì˜ˆ: 11.02.13 ë˜ëŠ” 2011.02.13" autocomplete="off" inputmode="numeric" />
          <button class="clearBtn" id="clearBirth" type="button" aria-label="clear">âœ•</button>
        </div>
        <div class="help">â€» ì (.) ì—†ì´ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤. (ì˜ˆ: 110213)</div>
      </div>

      <div class="cta">
        <button class="big" id="searchBtn" type="button">ì¡°íšŒ</button>
      </div>
    </div>

    <div id="result"></div>

    <div class="note">
      ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ <b>ì´ë¦„(ë˜ëŠ” ì•„ì´ë””) + ìƒë…„ì›”ì¼</b>ì´ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ ì¡°íšŒë©ë‹ˆë‹¤.
    </div>

  </div>

<script>
/* =========================================================
  âœ… Google Sheet (Publish CSV)
========================================================= */
const RAW_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTndQfKXAUuJaAZTbFYFhWbNhlhFmg2tNyaaRJRRLxYGCgUawZUeytRZ-aH9nusJ1SAUHtYYozgO6a0/pub?gid=0&single=true&output=csv";

/* =========================================================
  âœ… Cache/Retry/Timeout
========================================================= */
const CACHE_KEY = "KMT_STUDENTS_CACHE_V3";
const CACHE_TTL_MS = 10 * 60 * 1000;     // 10ë¶„
const FETCH_TIMEOUT_MS = 8000;           // 8ì´ˆ
const RETRY_COUNT = 2;                   // ì´ 3íšŒ ì‹œë„

const $ = (id)=>document.getElementById(id);
const dataPill = $("dataPill");
const timePill = $("timePill");
const statusText = $("statusText");
const resultEl = $("result");

let DATA_ROWS = null;            // í—¤ë” ì œì™¸ rows
let LOADING_PROMISE = null;
let LAST_LOADED_AT = null;       // Date
let LAST_SOURCE = null;          // "cache" | "network"

/* ---------- utils ---------- */
function clean(v){
  return (v ?? "")
    .toString()
    .replace(/^\uFEFF/, "")
    .replace(/\r/g, "")
    .replace(/^"|"$/g, "")
    .trim();
}
function norm(v){
  return clean(v).replace(/\s+/g,"").toLowerCase();
}
function onlyDigits(v){
  return clean(v).replace(/[^\d]/g,"");
}
/* ìƒë…„ì›”ì¼ ì •ê·œí™”:
   - "11.02.13" -> "110213"
   - "2011.02.13" -> "110213"
   - "110213" -> "110213"
*/
function normBirth(v){
  const d = onlyDigits(v);
  if(!d) return "";
  if(d.length === 6) return d;                    // yymmdd
  if(d.length === 8) return d.slice(2);           // yyyymmdd -> yymmdd
  // í˜¹ì‹œ 7ìë¦¬/5ìë¦¬ ë“± ì• ë§¤í•˜ë©´ ê·¸ëŒ€ë¡œ(ì¼ì¹˜ ì‹¤íŒ¨)
  return d;
}

function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

function fmtTime(dt){
  try{
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    const d = String(dt.getDate()).padStart(2,"0");
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${d} ${hh}:${mm}`;
  }catch{
    return "";
  }
}

/* ---------- CSV parse ---------- */
function splitCSVLine(line){
  const out = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(ch === "," && !inQuotes){
      out.push(cur); cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  const lines = text
    .split("\n")
    .map(l => l.replace(/\r/g,""))
    .filter(l => l.trim() !== "");

  const rows = lines
    .map(splitCSVLine)
    .map(cols => cols.map(clean));

  return rows;
}

/* ---------- cache ---------- */
function readCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.savedAt || !Array.isArray(obj.rows)) return null;
    if(Date.now() - obj.savedAt > CACHE_TTL_MS) return null;
    return obj;
  }catch{
    return null;
  }
}
function writeCache(rows, savedAt){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      savedAt: savedAt || Date.now(),
      rows
    }));
  }catch{}
}
function clearCache(){
  try{ localStorage.removeItem(CACHE_KEY); }catch{}
}

/* ---------- fetch with timeout ---------- */
async function fetchWithTimeout(url, ms){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }finally{
    clearTimeout(t);
  }
}

/* ---------- direct â†’ fallback allorigins ---------- */
async function fetchCSVText(){
  try{
    return await fetchWithTimeout(RAW_CSV, FETCH_TIMEOUT_MS);
  }catch(e1){
    const proxied = "https://api.allorigins.win/raw?url=" + encodeURIComponent(RAW_CSV);
    return await fetchWithTimeout(proxied, FETCH_TIMEOUT_MS);
  }
}

/* ---------- status UI ---------- */
function setStatus(type, pillText, msg){
  if(type === "good"){
    dataPill.className = "pill good";
  }else if(type === "bad"){
    dataPill.className = "pill bad";
  }else{
    dataPill.className = "pill";
  }
  dataPill.textContent = "ë°ì´í„°: " + pillText;
  statusText.textContent = msg || "";
}

function setTimePill(){
  if(!LAST_LOADED_AT){
    timePill.style.display = "none";
    return;
  }
  timePill.style.display = "inline-flex";
  const src = LAST_SOURCE === "cache" ? "ìºì‹œ" : "ìµœì‹ ";
  timePill.textContent = `ì—…ë°ì´íŠ¸: ${fmtTime(LAST_LOADED_AT)} Â· ${src}`;
}

/* ---------- load once ---------- */
async function loadOnce({force=false}={}){
  if(DATA_ROWS && !force) return DATA_ROWS;

  if(!force){
    const cached = readCache();
    if(cached){
      DATA_ROWS = cached.rows;
      LAST_LOADED_AT = new Date(cached.savedAt);
      LAST_SOURCE = "cache";
      setStatus("good", `ì¤€ë¹„(${DATA_ROWS.length}ëª…)`, `ì¡°íšŒëŠ” íœ´ëŒ€í° ì•ˆì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ë©ë‹ˆë‹¤`);
      setTimePill();
      return DATA_ROWS;
    }
  }

  if(LOADING_PROMISE) return LOADING_PROMISE;

  setStatus("loading", "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦");
  timePill.style.display = "none";

  LOADING_PROMISE = (async ()=>{
    let lastErr = null;

    for(let i=0;i<=RETRY_COUNT;i++){
      try{
        const csvText = await fetchCSVText();
        const rows = parseCSV(csvText);
        const data = rows.slice(1).filter(r => r && r.length && clean(r[0]) !== "");

        DATA_ROWS = data;
        LAST_LOADED_AT = new Date();
        LAST_SOURCE = "network";
        writeCache(data, Date.now());

        setStatus("good", `ì¤€ë¹„(${DATA_ROWS.length}ëª…)`, "ì¡°íšŒëŠ” íœ´ëŒ€í° ì•ˆì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ë©ë‹ˆë‹¤");
        setTimePill();
        return DATA_ROWS;
      }catch(err){
        lastErr = err;
        setStatus("loading", "ì¬ì‹œë„", `ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨â€¦ ì¬ì‹œë„ ì¤‘ (${i+1}/${RETRY_COUNT+1})`);
        await new Promise(r => setTimeout(r, 500 * (i+1)));
      }
    }

    throw lastErr;
  })();

  try{
    return await LOADING_PROMISE;
  }finally{
    LOADING_PROMISE = null;
  }
}

/* =========================================================
  âœ… Matching logic (ì´ë¦„/ì•„ì´ë””/ìƒë…„ì›”ì¼)
  - ì „ì´ì¬ë‹˜ ìš”ì²­: "ì´ë¦„ + ìƒë…„ì›”ì¼" ê°™ì´ ì…ë ¥í•´ì•¼ ì¡°íšŒë˜ê²Œ!
  - ì—¬ê¸°ì„œ 'ì´ë¦„ ë˜ëŠ” ì•„ì´ë””' + 'ìƒë…„ì›”ì¼'ì´ ë‘˜ ë‹¤ í•„ìˆ˜
========================================================= */
function matchRows(qNameOrId, qBirth){
  const q1 = norm(qNameOrId);
  const qb = normBirth(qBirth);

  if(!q1 || !qb) return [];

  // ì‹œíŠ¸ ê¸°ì¤€ ì—´:
  // 0 ì•„ì´ë””, 1 ì´ë¦„, 2 ìƒë…„ì›”ì¼(ì˜ˆ: 11.02.13), ...
  const out = [];
  for(const r of DATA_ROWS){
    const id = norm(r[0]);                 // KM002 -> km002
    const name = norm(r[1]);               // ê¹€ì˜ˆì„±
    const birth = normBirth(r[2]);         // 11.02.13 -> 110213

    // âœ… (ì´ë¦„ ë˜ëŠ” ì•„ì´ë””) AND (ìƒë…„ì›”ì¼) ë™ì‹œ ì¼ì¹˜
    const okNameOrId = (id && id === q1) || (name && name === q1) || (name && name.includes(q1)) || (id && id.includes(q1));
    const okBirth = (birth && birth === qb);

    if(okNameOrId && okBirth) out.push(r);
  }

  // ì •ë ¬: ì´ë¦„ ë™ì¼ì´ë©´ ì•„ì´ë”” ìˆœ
  out.sort((a,b)=> String(a[1]||"").localeCompare(String(b[1]||"")) || String(a[0]||"").localeCompare(String(b[0]||"")));
  return out;
}

/* ---------- UI render ---------- */
function renderCard(row){
  const id = clean(row[0]);
  const name = clean(row[1]);
  const birth = clean(row[2]);
  const tkd = clean(row[3]);
  const pm = clean(row[4]);
  const kendo = clean(row[5]);
  const photo = clean(row[6]);
  const point = clean(row[7]);
  const cert = clean(row[8]);
  const doc = clean(row[9]);

  return `
    <div class="card">
      <div class="top">
        <div class="photo">
          ${
            photo
              ? `<img src="${escapeHtml(photo)}"
                      alt="ì‚¬ì§„"
                      loading="lazy"
                      decoding="async"
                      referrerpolicy="no-referrer"
                      onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='NO PHOTO';" />`
              : `NO PHOTO`
          }
        </div>
        <div class="nameblock">
          <h2>${escapeHtml(name)}</h2>
          <p class="sub">ì•„ì´ë””: <b>${escapeHtml(id || "-")}</b> Â· ìƒë…„ì›”ì¼: <b>${escapeHtml(birth || "-")}</b></p>
          <div class="badge">í˜„ì¬ ìƒíƒœ ì¡°íšŒ ì™„ë£Œ</div>
        </div>
      </div>

      <div class="grid">
        <div class="row"><span class="rlabel">íƒœê¶Œë„ë‹¨ì¦</span><span class="rval">${escapeHtml(tkd || "-")}</span></div>
        <div class="row"><span class="rlabel">ê²½í˜¸ë¬´ìˆ ë‹¨ì¦</span><span class="rval">${escapeHtml(pm || "-")}</span></div>
        <div class="row"><span class="rlabel">ê²€ë„ë‹¨ì¦</span><span class="rval">${escapeHtml(kendo || "-")}</span></div>
        <div class="row"><span class="rlabel">í˜„ì¬í¬ì¸íŠ¸</span><span class="rval">${escapeHtml(point || "0")}</span></div>
        <div class="row"><span class="rlabel">ë³´ìœ ìê²©ì¦</span><span class="rval">${escapeHtml(cert || "-")}</span></div>
        <div class="row"><span class="rlabel">ë³´ìœ ì¸ì¦ì„œ</span><span class="rval">${escapeHtml(doc || "-")}</span></div>
      </div>
    </div>
  `;
}

function renderPickList(rows){
  const list = rows.map((r, idx)=>{
    const id = clean(r[0]);
    const name = clean(r[1]);
    const birth = clean(r[2]);
    const photo = clean(r[6]);

    return `
      <div class="pick" data-idx="${idx}">
        <div class="pLeft">
          <div class="thumb">
            ${
              photo
                ? `<img src="${escapeHtml(photo)}" alt="ì‚¬ì§„" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                        onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='NO';" />`
                : `NO`
            }
          </div>
          <div class="pInfo">
            <div class="pName">${escapeHtml(name || "-")}</div>
            <div class="pMeta">ì•„ì´ë””: ${escapeHtml(id || "-")} Â· ìƒë…„ì›”ì¼: ${escapeHtml(birth || "-")}</div>
          </div>
        </div>
        <div class="pGo">ì„ íƒ</div>
      </div>
    `;
  }).join("");

  return `<div class="message">ë™ì¼ ì¡°ê±´ìœ¼ë¡œ <b>${rows.length}ëª…</b>ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
          <div class="list" id="pickList">${list}</div>`;
}

/* ---------- search ---------- */
async function runSearch(){
  const q1 = $("qNameOrId").value;
  const qb = $("qBirth").value;

  resultEl.innerHTML = "";

  if(!clean(q1) || !clean(qb)){
    resultEl.innerHTML = `<div class="message">ì´ë¦„(ë˜ëŠ” ì•„ì´ë””)ê³¼ ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>`;
    return;
  }

  try{
    await loadOnce({force:false});
  }catch(e){
    console.error(e);
    setStatus("bad", "ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    resultEl.innerHTML = `<div class="message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br/>ìƒë‹¨ì˜ <b>ë°ì´í„° ìƒˆë¡œê³ ì¹¨</b>ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>`;
    return;
  }

  const rows = matchRows(q1, qb);

  if(rows.length === 0){
    resultEl.innerHTML = `<div class="message">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  // 1ëª…: ë°”ë¡œ ìƒì„¸
  if(rows.length === 1){
    resultEl.innerHTML = renderCard(rows[0]);
    return;
  }

  // ì—¬ëŸ¬ ëª…: ì„ íƒ ë¦¬ìŠ¤íŠ¸
  resultEl.innerHTML = renderPickList(rows);

  const pickList = $("pickList");
  if(pickList){
    pickList.addEventListener("click", (e)=>{
      const el = e.target.closest(".pick");
      if(!el) return;
      const idx = Number(el.getAttribute("data-idx"));
      const chosen = rows[idx];
      if(chosen) resultEl.innerHTML = renderCard(chosen);
    });
  }
}

/* ---------- clear buttons ---------- */
function bindClear(inputId, btnId){
  const input = $(inputId);
  const btn = $(btnId);

  function sync(){
    btn.style.display = input.value ? "inline-flex" : "none";
  }
  input.addEventListener("input", sync);
  btn.addEventListener("click", ()=>{
    input.value = "";
    input.focus();
    sync();
  });
  sync();
}

/* ---------- events ---------- */
$("searchBtn").addEventListener("click", runSearch);

document.addEventListener("keydown",(e)=>{
  if(e.key === "Enter") runSearch();
});

$("refreshBtn").addEventListener("click", async ()=>{
  resultEl.innerHTML = "";
  try{
    clearCache();
    DATA_ROWS = null;
    LAST_LOADED_AT = null;
    LAST_SOURCE = null;
    await loadOnce({force:true});
  }catch(e){
    console.error(e);
    setStatus("bad", "ì˜¤ë¥˜", "ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨â€¦ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
});

$("clearCacheBtn").addEventListener("click", ()=>{
  clearCache();
  DATA_ROWS = null;
  LAST_LOADED_AT = null;
  LAST_SOURCE = null;
  timePill.style.display = "none";
  setStatus("loading", "ìºì‹œ ì‚­ì œë¨", "ë‹¤ìŒ ì¡°íšŒ ì‹œ ìƒˆë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
});

bindClear("qNameOrId", "clearName");
bindClear("qBirth", "clearBirth");

/* í˜ì´ì§€ ì§„ì… ì‹œ: ìë™ 1íšŒ ë¡œë”© */
window.addEventListener("DOMContentLoaded", ()=>{
  loadOnce({force:false}).catch(e=>{
    console.error(e);
    setStatus("bad", "ëŒ€ê¸°", "ìë™ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒë‹¨ â€˜ë°ì´í„° ìƒˆë¡œê³ ì¹¨â€™ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
  });
});
</script>
</body>
</html>
