<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>수련생 조회</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#0b0f19;
  color:white;
  margin:0;
  padding:20px;
}

h1{
  text-align:center;
  margin-bottom:25px;
}

.search-box{
  text-align:center;
  margin-bottom:20px;
}

input{
  padding:10px;
  width:220px;
  border-radius:6px;
  border:none;
  font-size:16px;
}

button{
  padding:10px 15px;
  border:none;
  border-radius:6px;
  background:gold;
  font-weight:bold;
  cursor:pointer;
  margin-left:8px;
}

.card{
  background:#111827;
  padding:20px;
  border-radius:12px;
  max-width:420px;
  margin:25px auto;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
}

.card img{
  width:120px;
  border-radius:10px;
  display:block;
  margin:0 auto 15px;
}

.label{
  font-weight:bold;
  color:gold;
}

.message{
  text-align:center;
  margin-top:20px;
  font-size:15px;
}
</style>
</head>

<body>

<h1>수련생 조회</h1>

<div class="search-box">
  <input type="text" id="searchName" placeholder="이름 입력">
  <button onclick="searchStudent()">조회</button>
</div>

<div id="result"></div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTndQfKXAUuJaAZTbFYhWbNhlhFmg2tNyaaRJRRlxYGCgUawZUeytRZ-aH9nusJSAUHYYozgO6aO/pub?gid=0&single=true&output=csv";

/* ===== 문자열 정리 함수 ===== */
function clean(v){
  return (v ?? "")
    .toString()
    .replace(/^\uFEFF/, "")
    .replace(/\r/g, "")
    .replace(/^"|"$/g, "")
    .trim();
}

/* ===== CSV 한 줄 파서 ===== */
function splitCSVLine(line){
  const out = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < line.length; i++){
    const ch = line[i];

    if (ch === '"'){
      if (inQuotes && line[i+1] === '"'){
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } 
    else if (ch === ',' && !inQuotes){
      out.push(cur);
      cur = "";
    } 
    else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

/* ===== CSV 불러오기 ===== */
async function fetchData(){
  const res = await fetch(sheetURL, { cache: "no-store" });
  if(!res.ok){
    throw new Error("CSV 불러오기 실패: " + res.status);
  }

  const text = await res.text();
  const lines = text
    .split("\n")
    .map(l => l.replace(/\r/g,""))
    .filter(l => l.trim() !== "");

  const rows = lines
    .map(splitCSVLine)
    .map(r => r.map(clean));

  return rows;
}

/* ===== 조회 기능 ===== */
async function searchStudent(){
  const name = clean(document.getElementById("searchName").value);
  const resultEl = document.getElementById("result");
  resultEl.innerHTML = "";

  if(!name){
    resultEl.innerHTML = "<div class='message'>이름을 입력해주세요.</div>";
    return;
  }

  let rows;
  try{
    rows = await fetchData();
  } catch(e){
    resultEl.innerHTML = "<div class='message'>데이터를 불러오지 못했습니다.</div>";
    console.error(e);
    return;
  }

  let found = null;

  for(let i=1; i<rows.length; i++){
    if(clean(rows[i][1]) === name){
      found = rows[i];
      break;
    }
  }

  if(!found){
    resultEl.innerHTML = "<div class='message'>조회 결과가 없습니다.</div>";
    return;
  }

  const photo = clean(found[6]);

  resultEl.innerHTML = `
    <div class="card">
      ${photo ? `<img src="${photo}" alt="사진">` : ""}
      <p><span class="label">아이디:</span> ${clean(found[0])}</p>
      <p><span class="label">이름:</span> ${clean(found[1])}</p>
      <p><span class="label">생년월일:</span> ${clean(found[2])}</p>
      <p><span class="label">태권도단증:</span> ${clean(found[3])}</p>
      <p><span class="label">경호무술단증:</span> ${clean(found[4])}</p>
      <p><span class="label">검도단증:</span> ${clean(found[5])}</p>
      <p><span class="label">현재포인트:</span> ${clean(found[7])}</p>
      <p><span class="label">보유자격증:</span> ${clean(found[8])}</p>
      <p><span class="label">보유인증서:</span> ${clean(found[9])}</p>
    </div>
  `;
}
</script>

</body>
</html>
