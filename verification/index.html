<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>수련생 조회</title>

<style>
  :root{
    --bg:#0b0f19;
    --card:#111827;
    --line:rgba(255,255,255,.10);
    --text:#ffffff;
    --muted:rgba(255,255,255,.72);
    --gold:#f6c945;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:22px 18px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(900px 600px at 50% 0%, rgba(246,201,69,.12), transparent 55%),
                radial-gradient(900px 600px at 10% 20%, rgba(59,130,246,.10), transparent 55%),
                var(--bg);
    color:var(--text);
  }
  h1{
    text-align:center;
    margin:8px 0 10px;
    letter-spacing:-.5px;
    font-size:34px;
    font-weight:900;
  }

  .topbar{
    max-width:560px;
    margin:0 auto 10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .status{
    font-size:12px;
    color:rgba(255,255,255,.78);
    display:flex;
    align-items:center;
    gap:8px;
    min-height:20px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.85);
    font-weight:900;
  }
  .pill.good{ border-color: rgba(246,201,69,.35); background: rgba(246,201,69,.10); }
  .pill.bad{ border-color: rgba(255,99,99,.35); background: rgba(255,99,99,.10); }

  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .miniBtn{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    color:rgba(255,255,255,.90);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .miniBtn:active{transform:translateY(1px)}
  .miniBtn.gold{
    border-color: rgba(246,201,69,.35);
    background: rgba(246,201,69,.14);
  }

  .search-box{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:0 auto 14px;
    max-width:560px;
  }
  input{
    width:min(360px, 70vw);
    padding:12px 14px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
    font-size:16px;
    outline:none;
  }
  input:focus{
    border-color:rgba(246,201,69,.55);
    box-shadow:0 0 0 3px rgba(246,201,69,.15);
  }
  button.big{
    padding:12px 16px;
    border:0;
    border-radius:10px;
    background:var(--gold);
    color:#111;
    font-weight:900;
    cursor:pointer;
    min-width:72px;
  }
  button.big:active{transform:translateY(1px)}

  #result{margin-top:14px}
  .message{
    text-align:center;
    margin-top:16px;
    color:var(--muted);
    line-height:1.5;
  }
  .hint{
    max-width:720px;
    margin:14px auto 0;
    font-size:13px;
    color:rgba(255,255,255,.68);
    line-height:1.55;
    text-align:center;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:16px;
    padding:16px;
    max-width:520px;
    margin:16px auto 0;
    box-shadow: 0 14px 30px rgba(0,0,0,.35);
  }
  .top{
    display:flex;
    gap:14px;
    align-items:center;
  }
  .photo{
    width:110px;height:110px;border-radius:14px;
    background: rgba(255,255,255,.06);
    border:1px solid var(--line);
    overflow:hidden;
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,255,255,.55);
    font-weight:800;
  }
  .photo img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .nameblock h2{
    margin:0 0 6px;
    font-size:22px;
    font-weight:900;
    letter-spacing:-.3px;
  }
  .nameblock .sub{
    margin:0;
    color:rgba(255,255,255,.72);
    font-size:13px;
  }
  .grid{
    margin-top:14px;
    display:grid;
    grid-template-columns:1fr;
    gap:8px;
  }
  .row{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-radius:12px;
    background: rgba(17,24,39,.55);
    border:1px solid rgba(255,255,255,.07);
    font-size:14px;
  }
  .label{color:rgba(255,255,255,.70);font-weight:800}
  .val{color:#fff;font-weight:800;text-align:right}
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    margin-top:10px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(246,201,69,.35);
    background: rgba(246,201,69,.10);
    color: rgba(255,255,255,.90);
    font-size:12px;
    font-weight:800;
  }
  .debug{
    max-width:760px;
    margin:14px auto 0;
    background:#0f172a;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:12px;
    font-size:12px;
    white-space:pre-wrap;
    overflow:auto;
    color:rgba(255,255,255,.90);
  }
</style>
</head>

<body>
  <h1>수련생 조회</h1>

  <div class="topbar">
    <div class="status" id="statusLine">
      <span class="pill" id="dataPill">데이터: 준비중</span>
      <span id="statusText">페이지가 열리면 자동으로 1회 불러옵니다.</span>
    </div>
    <div class="actions">
      <button class="miniBtn gold" id="refreshBtn" type="button">데이터 새로고침</button>
      <button class="miniBtn" id="clearCacheBtn" type="button">캐시 삭제</button>
    </div>
  </div>

  <div class="search-box">
    <input id="searchName" type="text" placeholder="이름 또는 아이디 입력 (예: 김예담 / KM001)" autocomplete="off" />
    <button class="big" id="searchBtn" type="button">조회</button>
  </div>

  <div id="result"></div>

  <div class="hint">
    ※ 주소 끝에 <b>?debug=1</b> 을 붙이면(예: /verification/?debug=1) 불러온 행 수/일부 이름이 표시됩니다.<br/>
    ※ 이 페이지는 “처음 1회”만 구글시트를 불러오고, 그 다음 조회는 휴대폰 안(로컬)에서 즉시 처리합니다.
  </div>

<script>
/* =========================================================
  ✅ 전총재님 구글 시트 (웹에 게시 CSV)
========================================================= */
const RAW_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTndQfKXAUuJaAZTbFYFhWbNhlhFmg2tNyaaRJRRLxYGCgUawZUeytRZ-aH9nusJ1SAUHtYYozgO6a0/pub?gid=0&single=true&output=csv";

/* =========================================================
  ✅ 캐시/재시도/타임아웃 설정
========================================================= */
const CACHE_KEY = "KMT_STUDENTS_CACHE_V2";     // 버전 올리면 기존 캐시 자동 무효화
const CACHE_TTL_MS = 10 * 60 * 1000;          // 10분 캐시 (원하면 30분/1시간으로 늘리면 됨)
const FETCH_TIMEOUT_MS = 8000;                // 8초 타임아웃
const RETRY_COUNT = 2;                        // 실패 시 추가 재시도 횟수 (총 1+2=3회 시도)

/* debug */
const DEBUG = new URLSearchParams(location.search).get("debug") === "1";

/* 상태 */
const $ = (id)=>document.getElementById(id);
const statusText = $("statusText");
const dataPill = $("dataPill");
const resultEl = $("result");

let DATA_ROWS = null;          // header 제외한 실제 데이터 배열(행)
let LOADING_PROMISE = null;    // 중복 fetch 방지

/* ---------- 문자열 정리 ---------- */
function clean(v){
  return (v ?? "")
    .toString()
    .replace(/^\uFEFF/, "")     // BOM
    .replace(/\r/g, "")         // CR
    .replace(/^"|"$/g, "")      // 양끝 따옴표
    .trim();
}
function norm(v){
  return clean(v).replace(/\s+/g,"").toLowerCase();
}

/* ---------- CSV 파서(따옴표/콤마 안전) ---------- */
function splitCSVLine(line){
  const out = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(ch === "," && !inQuotes){
      out.push(cur); cur = "";
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCSV(text){
  const lines = text
    .split("\n")
    .map(l => l.replace(/\r/g,""))
    .filter(l => l.trim() !== "");

  const rows = lines
    .map(splitCSVLine)
    .map(cols => cols.map(clean));

  return rows;
}

/* ---------- 캐시 ---------- */
function readCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.savedAt || !Array.isArray(obj.rows)) return null;
    if(Date.now() - obj.savedAt > CACHE_TTL_MS) return null;
    return obj.rows;
  }catch{
    return null;
  }
}
function writeCache(rows){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      savedAt: Date.now(),
      rows
    }));
  }catch{}
}
function clearCache(){
  try{ localStorage.removeItem(CACHE_KEY); }catch{}
}

/* ---------- fetch with timeout ---------- */
async function fetchWithTimeout(url, ms){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }finally{
    clearTimeout(t);
  }
}

/* ---------- CSV 로딩: direct → 실패 시 allorigins fallback ---------- */
async function fetchCSVText(){
  // 1) direct
  try{
    return await fetchWithTimeout(RAW_CSV, FETCH_TIMEOUT_MS);
  }catch(e1){
    // 2) fallback via allorigins
    const proxied = "https://api.allorigins.win/raw?url=" + encodeURIComponent(RAW_CSV);
    return await fetchWithTimeout(proxied, FETCH_TIMEOUT_MS);
  }
}

/* ---------- 1회만 로딩 (중복 방지) ---------- */
async function loadOnce({force=false}={}){
  if(DATA_ROWS && !force) return DATA_ROWS;

  if(!force){
    const cached = readCache();
    if(cached){
      DATA_ROWS = cached;
      setStatus("good", `캐시 사용 (${cached.length}명)`, `데이터 준비 완료 · 조회는 즉시 됩니다`);
      if(DEBUG) renderDebug(cached, true);
      return DATA_ROWS;
    }
  }

  if(LOADING_PROMISE) return LOADING_PROMISE;

  setStatus("loading", "불러오는 중", "구글 시트 데이터를 불러오는 중입니다…");

  LOADING_PROMISE = (async ()=>{
    let lastErr = null;

    for(let i=0;i<=RETRY_COUNT;i++){
      try{
        const csvText = await fetchCSVText();
        const rows = parseCSV(csvText);

        // rows[0] = header
        const data = rows.slice(1).filter(r => r && r.length && clean(r[0]) !== "");
        DATA_ROWS = data;
        writeCache(data);

        setStatus("good", `데이터 준비 (${data.length}명)`, "이제 조회는 휴대폰 안에서 즉시 처리됩니다");
        if(DEBUG) renderDebug(data, false);
        return DATA_ROWS;
      }catch(err){
        lastErr = err;
        setStatus("loading", "재시도", `불러오기 실패… 재시도 중 (${i+1}/${RETRY_COUNT+1})`);
        await new Promise(r => setTimeout(r, 500 * (i+1)));
      }
    }

    throw lastErr;
  })();

  try{
    return await LOADING_PROMISE;
  }finally{
    LOADING_PROMISE = null;
  }
}

/* ---------- 상태 UI ---------- */
function setStatus(type, pillText, msg){
  if(type === "good"){
    dataPill.className = "pill good";
  }else if(type === "bad"){
    dataPill.className = "pill bad";
  }else{
    dataPill.className = "pill";
  }
  dataPill.textContent = "데이터: " + pillText;
  statusText.textContent = msg || "";
}

/* ---------- 카드 ---------- */
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

function renderCard(row){
  // 0 아이디, 1 이름, 2 생년월일, 3 태권도단증, 4 경호무술단증, 5 검도단증,
  // 6 포토링크, 7 현재포인트, 8 보유자격증, 9 보유인증서
  const id = clean(row[0]);
  const name = clean(row[1]);
  const birth = clean(row[2]);
  const tkd = clean(row[3]);
  const pm = clean(row[4]);
  const kendo = clean(row[5]);
  const photo = clean(row[6]);
  const point = clean(row[7]);
  const cert = clean(row[8]);
  const doc = clean(row[9]);

  return `
    <div class="card">
      <div class="top">
        <div class="photo">
          ${
            photo
              ? `<img src="${escapeHtml(photo)}"
                      alt="사진"
                      loading="lazy"
                      decoding="async"
                      referrerpolicy="no-referrer" />`
              : `NO PHOTO`
          }
        </div>
        <div class="nameblock">
          <h2>${escapeHtml(name)}</h2>
          <p class="sub">아이디: <b>${escapeHtml(id || "-")}</b> · 생년월일: <b>${escapeHtml(birth || "-")}</b></p>
          <div class="badge">현재 상태 조회 완료</div>
        </div>
      </div>

      <div class="grid">
        <div class="row"><span class="label">태권도단증</span><span class="val">${escapeHtml(tkd || "-")}</span></div>
        <div class="row"><span class="label">경호무술단증</span><span class="val">${escapeHtml(pm || "-")}</span></div>
        <div class="row"><span class="label">검도단증</span><span class="val">${escapeHtml(kendo || "-")}</span></div>
        <div class="row"><span class="label">현재포인트</span><span class="val">${escapeHtml(point || "0")}</span></div>
        <div class="row"><span class="label">보유자격증</span><span class="val">${escapeHtml(cert || "-")}</span></div>
        <div class="row"><span class="label">보유인증서</span><span class="val">${escapeHtml(doc || "-")}</span></div>
      </div>
    </div>
  `;
}

/* ---------- 디버그 ---------- */
function renderDebug(dataRows, fromCache){
  const names = dataRows.map(r => clean(r[1])).filter(Boolean);
  const txt = [
    "DEBUG MODE ON",
    `source: ${fromCache ? "localStorage cache" : "network fetch"}`,
    `rows: ${dataRows.length}`,
    "first 10 names:",
    ...names.slice(0,10).map((n,i)=>`${i+1}. ${n}`)
  ].join("\n");

  let dbg = document.querySelector(".debug");
  if(!dbg){
    dbg = document.createElement("div");
    dbg.className = "debug";
    document.body.appendChild(dbg);
  }
  dbg.textContent = txt;
}

/* ---------- 로컬 검색 ---------- */
function findStudent(keyword){
  const k = norm(keyword);
  if(!k) return null;

  // 우선: 아이디 완전일치
  for(const row of DATA_ROWS){
    if(norm(row[0]) === k) return row;
  }
  // 다음: 이름 완전일치
  for(const row of DATA_ROWS){
    if(norm(row[1]) === k) return row;
  }
  // 마지막: 부분일치(이름/아이디)
  for(const row of DATA_ROWS){
    const id = norm(row[0]);
    const name = norm(row[1]);
    if((id && id.includes(k)) || (name && name.includes(k))) return row;
  }
  return null;
}

/* ---------- 검색 실행 ---------- */
async function searchStudent(){
  const input = $("searchName").value;
  resultEl.innerHTML = "";

  if(!clean(input)){
    resultEl.innerHTML = `<div class="message">이름 또는 아이디를 입력해주세요.</div>`;
    return;
  }

  // 데이터가 없으면 먼저 1회 로딩
  try{
    await loadOnce({force:false});
  }catch(e){
    console.error(e);
    setStatus("bad", "오류", "데이터를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.");
    resultEl.innerHTML = `<div class="message">데이터를 불러오지 못했습니다.<br/>오른쪽 위 <b>데이터 새로고침</b>을 눌러보세요.</div>`;
    return;
  }

  const found = findStudent(input);

  if(!found){
    resultEl.innerHTML = `<div class="message">조회 결과가 없습니다.</div>`;
    return;
  }

  resultEl.innerHTML = renderCard(found);
}

/* ---------- 버튼/이벤트 ---------- */
$("searchBtn").addEventListener("click", searchStudent);

// 엔터키로 조회
document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter") searchStudent();
});

// 데이터 새로고침(강제로 네트워크 재로딩)
$("refreshBtn").addEventListener("click", async ()=>{
  resultEl.innerHTML = "";
  try{
    clearCache();
    DATA_ROWS = null;
    await loadOnce({force:true});
  }catch(e){
    console.error(e);
    setStatus("bad", "오류", "새로고침 실패… 네트워크 상태를 확인해주세요.");
  }
});

// 캐시 삭제(데이터만 지움, 새로고침은 안 함)
$("clearCacheBtn").addEventListener("click", ()=>{
  clearCache();
  DATA_ROWS = null;
  setStatus("loading", "캐시 삭제됨", "다음 조회 시 새로 불러옵니다.");
});

// 페이지 진입 시: 자동 1회 로딩 (조회 체감 속도 ↑)
window.addEventListener("DOMContentLoaded", ()=>{
  loadOnce({force:false}).catch(e=>{
    console.error(e);
    setStatus("bad", "대기", "자동 불러오기에 실패했습니다. 조회 버튼을 누르거나 ‘데이터 새로고침’을 눌러주세요.");
  });
});
</script>
</body>
</html>
